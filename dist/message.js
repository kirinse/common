define("kirin/common/1.0.0/message",["jquery/jquery/1.7.2/jquery","arale/templatable/0.9.2/templatable","$","gallery/handlebars/1.0.2/handlebars","./dropdown","arale/popup/1.1.6/popup","arale/overlay/1.1.4/overlay","arale/position/1.0.1/position","arale/iframe-shim/1.0.2/iframe-shim","arale/widget/1.1.1/widget","arale/base/1.1.1/base","arale/class/1.1.0/class","arale/events/1.1.0/events","./count"],function(a,b,c){function d(a){h.ajax(o.getmessage,{dataType:"json"}).success(function(b){if("ok"===b.stat){var c=parseInt(b.totalCount,10);m.setCount(c),a(b)}else m.hideCount()})}function e(a){return a.sort(function(a,b){return b.level-a.level})}function f(a){var b=0,c={infos:e(a.infos)},d=k.compile('{{#infos}}<li class="{{messageClass}} global-list-level{{level}}" data-id="{{id}}" data-level="{{level}}">{{{messageContent this}}}<a href="javascript:void(0);" class="global-list-close" seed="global-msg-close">X</a></li>{{/infos}}');return k.registerHelper("messageClass",function(){return b++>=3?"fn-hide":""}),k.registerHelper("messageContent",function(a){var b=a.url,c=a.content.length>46?a.content.replace(/^(.{43}).*$/,"$1..."):a.content;return/^(http|https)/i.test(b)?(b=o.redirecturl+"?msgId="+a.id+"&url="+b,'<a href="'+b+'" target="_blank" class="global-list-msg-content" seed="global-msg-item">'+c+"</a>"):'<span class="global-list-msg-content">'+c+"</span>"}),d(c)}function g(a){var b=this.$(".global-toplink-msgCount"),c=this.$("#global-list-msg"),d=c.children().length;b.html(d-1),m.setCount(d-1),d>3&&c.children(".fn-hide:first").removeClass("fn-hide"),h(a).parent().hide(400,"swing",function(){h(this).remove()})}var h=a("jquery/jquery/1.7.2/jquery"),i=a("arale/templatable/0.9.2/templatable"),j=a("./dropdown"),k=a("gallery/handlebars/1.0.2/handlebars"),l=a("arale/position/1.0.1/position"),m=a("./count"),n=(window.GLOBAL||{},!1),o={redirecturl:"/app/kirinResource/messageCenter/modifyStatusAndRedirect.html",getmessage:"/app/kirinResource/messageCenter/getMsgInfosNew",popmessage:"/app/kirinResource/messageCenter/popMsgInfos",readmessage:"/app/kirinResource/messageCenter/readMsg?&historySource=I&msgIds="},p=j.extend({Implements:i,Statics:{getMessageCount:d},events:{"click #global-msg-isee":"markAllRead","click #global-list-msg a.global-list-msg-content":function(a){g.call(this,a.currentTarget)},"click #global-list-msg a.global-list-close":"markRead","click #global-msg-confirm-ok":"confirmOk","click #global-msg-confirm-cancel":"confirmCancel","mouseenter .global-list li":function(a){h(a.currentTarget).addClass("global-list-hover")},"mouseleave .global-list li":function(a){h(a.currentTarget).removeClass("global-list-hover")}},show:function(){var a=this;return n||h.ajax(o.popmessage,{dataType:"json"}).success(function(b){"ok"===b.stat&&(m.setCount(b.totalCount),a.renderMsg(b))}),m.getCount()>0?p.superclass.show.call(this):this},renderMsg:function(a){return n||(this.$(".global-toplink-msgCount").html(a.totalCount),this.$("#global-list-msg").html(f(a)).removeClass("global-loading"),n=!0),this},markAllRead:function(a){a.preventDefault(),m.setCount(0);var b=this.$("#global-list-msg li").map(function(){return h(this).attr("data-id")}).get().join(",");this.hide(),this.$("#global-list-msg").html(),h.ajax(o.readmessage+b,{dataType:"json"})},markRead:function(a){var b=a.currentTarget,c=h(b).parent(),d=this.$("#global-msg-confirm"),e=c.attr("data-id");this.currentConfirmMsg&&(h(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null),3==c.attr("data-level")?(this.currentConfirmMsg=b,c.css("height",d.height()-16),d.show(),l.pin(d[0],c[0])):(d.hide(),g.call(this,b),h.ajax(o.readmessage+e,{dataType:"json"}))},confirmOk:function(a){a.preventDefault();var b=h(this.currentConfirmMsg).parent().attr("data-id");this.$("#global-msg-confirm").hide(),g.call(this,this.currentConfirmMsg),h.ajax(o.readmessage+b,{dataType:"json"})},confirmCancel:function(a){a.preventDefault(),h(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null,this.$("#global-msg-confirm").hide()}});c.exports=p}),define("kirin/common/1.0.0/dropdown",["arale/popup/1.1.6/popup","$","arale/overlay/1.1.4/overlay","arale/position/1.0.1/position","arale/iframe-shim/1.0.2/iframe-shim","arale/widget/1.1.1/widget","arale/base/1.1.1/base","arale/class/1.1.0/class","arale/events/1.1.0/events"],function(a,b,c){var d=a("arale/popup/1.1.6/popup"),e=d.extend({setup:function(){e.superclass.setup.call(this),this._tweakAlignDefaultValue()},_tweakAlignDefaultValue:function(){var a=this.get("align");a.baseXY.toString()===[0,0].toString()&&(a.baseXY=[0,"100%"]),"VIEWPORT"===a.baseElement._id&&(a.baseElement=this.get("trigger")),this.set("align",a)}});c.exports=e}),define("kirin/common/1.0.0/count",["jquery/jquery/1.7.2/jquery"],function(a,b,c){function d(){return e||(e=f('<span class="global-toplink-msgCount"></span>').addClass("fn-hide").appendTo(g)),e}var e,f=a("jquery/jquery/1.7.2/jquery"),g=f("#global-header-msg .global-toplink-msg"),h={count:0,setCount:function(a){this.count=a,a>99&&(a="99+"),0==a?g.removeClass("global-toplink-msg-active"):g.addClass("global-toplink-msg-active"),d().html(a).removeClass("fn-hide")},getCount:function(){return this.count},hideCount:function(){g.removeClass("global-toplink-msg-active"),d().addClass("fn-hide")}};c.exports=h});
