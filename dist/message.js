define("kirin/common/1.0.0/message",["jquery","templatable","handlebars","./dropdown","popup","overlay","position","iframe-shim","widget","base","./count"],function(a,b,c){function d(a){h.ajax(p.getmessage,{dataType:"jsonp"}).success(function(b){if("ok"===b.stat){var c=parseInt(b.totalCount,10);m.setCount(c),a(b)}else m.hideCount()})}function e(a){return a.sort(function(a,b){return b.level-a.level})}function f(a){var b=0,c={infos:e(a.infos)},d=k.compile('{{#infos}}<li class="{{messageClass}} global-list-level{{level}}" data-id="{{id}}" data-level="{{level}}">{{{messageContent this}}}<a href="javascript:void(0);" class="global-list-close" seed="global-msg-close">X</a></li>{{/infos}}');return k.registerHelper("messageClass",function(){return b++>=3?"fn-hide":""}),k.registerHelper("messageContent",function(a){var b=a.url,c=a.content.length>46?a.content.replace(/^(.{43}).*$/,"$1..."):a.content;return/^(http|https)/i.test(b)?(b=p.redirecturl+"?msgId="+a.id+"&url="+b,'<a href="'+b+'" target="_blank" class="global-list-msg-content" seed="global-msg-item">'+c+"</a>"):'<span class="global-list-msg-content">'+c+"</span>"}),d(c)}function g(a){var b=this.$(".global-toplink-msgCount"),c=this.$("#global-list-msg"),d=c.children().length;b.html(d-1),m.setCount(d-1),d>3&&c.children(".fn-hide:first").removeClass("fn-hide"),h(a).parent().hide(400,"swing",function(){h(this).remove()})}var h=a("jquery"),i=a("templatable"),j=a("./dropdown"),k=a("handlebars"),l=a("position"),m=a("./count"),n=window.GLOBAL||{},o=!1,p={redirecturl:n.system.personal+"/user/msgcenter/modifyStatusAndRedirect.htm",getmessage:n.system.personal+"/user/msgcenter/getMsgInfosNew.json?_callback=?",popmessage:n.system.personal+"/user/msgcenter/popMsgInfos.json?_callback=?",readmessage:n.system.personal+"/user/msgcenter/readMsg.json?_callback=?&historySource=I&msgIds="},q=j.extend({Implements:i,Statics:{getMessageCount:d},events:{"click #global-msg-isee":"markAllRead","click #global-list-msg a.global-list-msg-content":function(a){g.call(this,a.currentTarget)},"click #global-list-msg a.global-list-close":"markRead","click #global-msg-confirm-ok":"confirmOk","click #global-msg-confirm-cancel":"confirmCancel","mouseenter .global-list li":function(a){h(a.currentTarget).addClass("global-list-hover")},"mouseleave .global-list li":function(a){h(a.currentTarget).removeClass("global-list-hover")}},show:function(){var a=this;return o||h.ajax(p.popmessage,{dataType:"jsonp"}).success(function(b){"ok"===b.stat&&(m.setCount(b.totalCount),a.renderMsg(b))}),m.getCount()>0?q.superclass.show.call(this):this},renderMsg:function(a){return o||(this.$(".global-toplink-msgCount").html(a.totalCount),this.$("#global-list-msg").html(f(a)).removeClass("global-loading"),o=!0),this},markAllRead:function(a){a.preventDefault(),m.setCount(0);var b=this.$("#global-list-msg li").map(function(){return h(this).attr("data-id")}).get().join(",");this.hide(),this.$("#global-list-msg").html(),h.ajax(p.readmessage+b,{dataType:"jsonp"})},markRead:function(a){var b=a.currentTarget,c=h(b).parent(),d=this.$("#global-msg-confirm"),e=c.attr("data-id");this.currentConfirmMsg&&(h(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null),3==c.attr("data-level")?(this.currentConfirmMsg=b,c.css("height",d.height()-16),d.show(),l.pin(d[0],c[0])):(d.hide(),g.call(this,b),h.ajax(p.readmessage+e,{dataType:"jsonp"}))},confirmOk:function(a){a.preventDefault();var b=h(this.currentConfirmMsg).parent().attr("data-id");this.$("#global-msg-confirm").hide(),g.call(this,this.currentConfirmMsg),h.ajax(p.readmessage+b,{dataType:"jsonp"})},confirmCancel:function(a){a.preventDefault(),h(this.currentConfirmMsg).parent().css("height","auto"),this.currentConfirmMsg=null,this.$("#global-msg-confirm").hide()}});c.exports=q}),define("kirin/common/1.0.0/dropdown",["popup","jquery","overlay","position","iframe-shim","widget","base"],function(a,b,c){var d=a("popup"),e=d.extend({setup:function(){e.superclass.setup.call(this),this._tweakAlignDefaultValue()},_tweakAlignDefaultValue:function(){var a=this.get("align");a.baseXY.toString()===[0,0].toString()&&(a.baseXY=[0,"100%"]),"VIEWPORT"===a.baseElement._id&&(a.baseElement=this.get("trigger")),this.set("align",a)}});c.exports=e}),define("kirin/common/1.0.0/count",["jquery"],function(a,b,c){function d(){return e||(e=f('<span class="global-toplink-msgCount"></span>').addClass("fn-hide").appendTo(g)),e}var e,f=a("jquery"),g=f("#global-header-msg .global-toplink-msg"),h={count:0,setCount:function(a){this.count=a,a>99&&(a="99+"),0==a?g.removeClass("global-toplink-msg-active"):g.addClass("global-toplink-msg-active"),d().html(a).removeClass("fn-hide")},getCount:function(){return this.count},hideCount:function(){g.removeClass("global-toplink-msg-active"),d().addClass("fn-hide")}};c.exports=h});
